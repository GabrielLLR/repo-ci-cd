name: Jira Task Creation

on:
  workflow_call:
    secrets:
      JIRA_URL:
        required: true
      JIRA_USER:
        required: true
      JIRA_API_TOKEN:
        required: true
      JIRA_PROJECT:
        required: true
    inputs:
      PR_TITLE:
        required: true
        type: string
      PR_URL:
        required: true
        type: string
      PR_AUTHOR:
        required: true
        type: string

jobs:
  jira:
    runs-on: ubuntu-latest
    steps:
      - name: Validar Secrets Necess√°rias
        run: |
          if [[ -z "${{ secrets.JIRA_URL }}" || -z "${{ secrets.JIRA_USER }}" || -z "${{ secrets.JIRA_API_TOKEN }}" || -z "${{ secrets.JIRA_PROJECT }}" ]]; then
            echo "‚ùå Uma ou mais secrets obrigat√≥rias n√£o est√£o definidas."
            exit 1
          fi
          echo "‚úÖ Todas as secrets obrigat√≥rias est√£o definidas."

      - name: Criar Task no Jira
        id: create-jira-task
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT: ${{ secrets.JIRA_PROJECT }}
          JIRA_ISSUE_TYPE: "Task"
        run: |
          PR_TITLE="${{ inputs.PR_TITLE }}"
          PR_URL="${{ inputs.PR_URL }}"
          PR_AUTHOR="${{ inputs.PR_AUTHOR }}"

          DESCRIPTION=$(jq -Rs '.' <<< "Revis√£o do PR: $PR_TITLE. Link do PR: $PR_URL Criado por: $PR_AUTHOR")

          ISSUE_PAYLOAD=$(jq -n \
            --arg project "$JIRA_PROJECT" \
            --arg summary "Revis√£o do PR: $PR_TITLE" \
            --arg description "$DESCRIPTION" \
            --arg issuetype "$JIRA_ISSUE_TYPE" \
            '{ fields: { project: { key: $project }, summary: $summary, description: $description | fromjson, issuetype: { name: $issuetype } } }')

          echo "üìù Criando issue no Jira..."
          echo "Payload enviado: $ISSUE_PAYLOAD"

          RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_API_TOKEN" \
            --data "$ISSUE_PAYLOAD" "$JIRA_URL/rest/api/2/issue/")

          echo "Resposta da API: $RESPONSE"

          ISSUE_ID=$(echo "$RESPONSE" | jq -r '.id')
          ISSUE_KEY=$(echo "$RESPONSE" | jq -r '.key')

          if [[ "$ISSUE_ID" == "null" || -z "$ISSUE_ID" ]]; then
            echo "‚ùå Erro ao criar issue no Jira!"
            exit 1
          fi

          echo "JIRA_ISSUE_ID=$ISSUE_ID" >> $GITHUB_ENV
          echo "JIRA_ISSUE_KEY=$ISSUE_KEY" >> $GITHUB_ENV
          echo "‚úÖ Tarefa Jira criada: $ISSUE_KEY (ID: $ISSUE_ID)"

      - name: Criar Arquivos de Relat√≥rio (Simula√ß√£o)
        run: |
          echo "Este √© o relat√≥rio do Spectral" > spectral_report.txt
          echo "Este √© o relat√≥rio do Vale" > vale_report.txt
          echo "Este √© o relat√≥rio do PB33F" > pb33f_report.txt

      - name: Anexar Relat√≥rios ao Jira Task
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_ISSUE_ID: ${{ env.JIRA_ISSUE_ID }}
        run: |
          echo "üìé Anexando relat√≥rios √† issue $JIRA_ISSUE_ID"

          for file in spectral_report.txt vale_report.txt pb33f_report.txt; do
            if [[ -f "$file" ]]; then
              echo "üìé Anexando $file..."
              curl -X POST -H "X-Atlassian-Token: no-check" \
                   -H "Authorization: Basic $(echo -n "$JIRA_USER:$JIRA_API_TOKEN" | base64)" \
                   -H "Content-Type: multipart/form-data" \
                   -F "file=@$file" \
                   "$JIRA_URL/rest/api/2/issue/$JIRA_ISSUE_ID/attachments"
              echo "‚úÖ $file anexado com sucesso!"
            else
              echo "‚ö†Ô∏è Arquivo $file n√£o encontrado, pulando..."
            fi
          done

      - name: Mudar status da Task para "Em Andamento"
        env:
          JIRA_URL: ${{ secrets.JIRA_URL }}
          JIRA_USER: ${{ secrets.JIRA_USER }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
        run: |
          echo "üîÑ Executando transi√ß√£o para 'Em Andamento' com ID 31..."
          TRANSITION_PAYLOAD='{"transition": {"id": "31"}}'

          TRANSITION_RESPONSE=$(curl -s -X POST -H "Content-Type: application/json" \
            -u "$JIRA_USER:$JIRA_API_TOKEN" \
            --data "$TRANSITION_PAYLOAD" \
            "$JIRA_URL/rest/api/2/issue/$JIRA_ISSUE_ID/transitions")

          if [[ "$TRANSITION_RESPONSE" == *"errorMessages"* ]]; then
            echo "‚ùå Erro ao atualizar status da Task!"
            exit 1
          fi

          echo "‚úÖ Status da Task atualizado para 'Em Andamento'."
